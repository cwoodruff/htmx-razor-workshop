@using RazorPagesHtmxWorkshop.Models
@model TaskListVm

@*
    Task List Fragment with Pagination
    ===================================
    
    Target ID: #task-list
    Swap: outerHTML
    Returned by: OnGetList, OnPostCreate (on success), OnPostDelete (on success)
    
    Features:
    - Displays filtered/paginated task list
    - Pagination controls with hx-push-url
    - Delete and Details buttons per row
    
    Model: TaskListVm (includes items, page info, filter query)
*@

<div id="task-list">
    @if (Model.Items.Count == 0)
    {
        <div class="text-muted py-4 text-center">
            @if (!string.IsNullOrWhiteSpace(Model.Query))
            {
                <p class="mb-2">No tasks match "<strong>@Model.Query</strong>"</p>
                <a href="?" 
                   hx-get="?"
                   hx-target="#task-list"
                   hx-swap="outerHTML"
                   hx-push-url="true"
                   class="btn btn-sm btn-outline-secondary">
                    Clear filter
                </a>
            }
            else
            {
                <p class="mb-0">No tasks yet. Add one above!</p>
            }
        </div>
    }
    else
    {
        <ul class="list-group list-group-flush">
            @foreach (var task in Model.Items)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <div class="d-flex flex-column">
                        <strong>@task.Title</strong>
                        <span class="small text-muted">
                            Created @task.CreatedUtc.ToLocalTime().ToString("g")
                        </span>
                    </div>
                    
                    <div class="d-flex align-items-center gap-2">
                        @if (task.IsDone)
                        {
                            <span class="badge text-bg-success">Done</span>
                        }
                        else
                        {
                            <span class="badge text-bg-secondary">Open</span>
                        }
                        
                        <div class="btn-group btn-group-sm">
                            @* Details button - loads into modal *@
                            <button type="button" 
                                    class="btn btn-outline-secondary"
                                    hx-get="?handler=Details&id=@task.Id"
                                    hx-target="#task-modal-container"
                                    hx-indicator="#task-loading">
                                Details
                            </button>
                            
                            @* Delete button with confirmation *@
                            <button type="button"
                                    class="btn btn-outline-danger"
                                    hx-post="?handler=Delete"
                                    hx-vals='{"id": @task.Id}'
                                    hx-confirm="Delete this task? This cannot be undone."
                                    hx-target="#task-list"
                                    hx-swap="outerHTML"
                                    hx-indicator="#task-loading">
                                Delete
                            </button>
                        </div>
                    </div>
                </li>
            }
        </ul>

        @* Pagination Controls *@
        @if (Model.TotalPages > 1)
        {
            <nav class="mt-3" aria-label="Task list pagination">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    @* Previous button *@
                    <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                        @if (Model.HasPreviousPage)
                        {
                            <a class="page-link"
                               href="?q=@Model.Query&page=@(Model.Page - 1)&pageSize=@Model.PageSize"
                               hx-get="?q=@Model.Query&page=@(Model.Page - 1)&pageSize=@Model.PageSize"
                               hx-target="#task-list"
                               hx-swap="outerHTML"
                               hx-push-url="true"
                               hx-indicator="#task-loading">
                                Previous
                            </a>
                        }
                        else
                        {
                            <span class="page-link" tabindex="-1" aria-disabled="true">Previous</span>
                        }
                    </li>
                    
                    @* Page numbers *@
                    @for (var p = 1; p <= Model.TotalPages; p++)
                    {
                        var isActive = p == Model.Page;
                        <li class="page-item @(isActive ? "active" : "")">
                            @if (isActive)
                            {
                                <span class="page-link" aria-current="page">@p</span>
                            }
                            else
                            {
                                <a class="page-link"
                                   href="?q=@Model.Query&page=@p&pageSize=@Model.PageSize"
                                   hx-get="?q=@Model.Query&page=@p&pageSize=@Model.PageSize"
                                   hx-target="#task-list"
                                   hx-swap="outerHTML"
                                   hx-push-url="true"
                                   hx-indicator="#task-loading">
                                    @p
                                </a>
                            }
                        </li>
                    }
                    
                    @* Next button *@
                    <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                        @if (Model.HasNextPage)
                        {
                            <a class="page-link"
                               href="?q=@Model.Query&page=@(Model.Page + 1)&pageSize=@Model.PageSize"
                               hx-get="?q=@Model.Query&page=@(Model.Page + 1)&pageSize=@Model.PageSize"
                               hx-target="#task-list"
                               hx-swap="outerHTML"
                               hx-push-url="true"
                               hx-indicator="#task-loading">
                                Next
                            </a>
                        }
                        else
                        {
                            <span class="page-link" tabindex="-1" aria-disabled="true">Next</span>
                        }
                    </li>
                </ul>
            </nav>
            
            <div class="text-center text-muted small mt-2">
                Showing @((Model.Page - 1) * Model.PageSize + 1)â€“@(Math.Min(Model.Page * Model.PageSize, Model.Total)) of @Model.Total tasks
            </div>
        }
        else
        {
            <div class="text-center text-muted small mt-2">
                @Model.Total task@(Model.Total == 1 ? "" : "s")
            </div>
        }
    }
</div>
