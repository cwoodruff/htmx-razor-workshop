@using RazorPagesHtmxWorkshop.Models
@model TaskListVm

@*
    Task List Fragment with Pagination
    ===================================
    
    Target ID: #task-list
    Swap: outerHTML
    Returned by: OnGetList, OnPostCreate (on success), OnPostDelete (on success)
    
    Features:
    - Displays filtered/paginated task list
    - Pagination controls with hx-push-url
    - Delete and Details buttons per row
    
    Model: TaskListVm (includes items, page info, filter query)
*@

<div id="task-list">
    @if (Model.Items.Count == 0)
    {
        <div class="text-muted py-4 text-center">
            @if (!string.IsNullOrWhiteSpace(Model.Query))
            {
                <p class="mb-2">No tasks match "<strong>@Model.Query</strong>"</p>
                <a href="?" 
                   hx-get="?"
                   hx-target="#task-list"
                   hx-swap="outerHTML"
                   hx-push-url="true"
                   class="btn btn-sm btn-outline-secondary">
                    Clear filter
                </a>
            }
            else
            {
                <p class="mb-0">No tasks yet. Add one above!</p>
            }
        </div>
    }
    else
    {
        <ul class="list-group list-group-flush">
            @foreach (var task in Model.Items)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <div class="d-flex flex-column">
                        <strong>@task.Title</strong>
                        <span class="small text-muted">
                            Created @task.CreatedUtc.ToLocalTime().ToString("g")
                        </span>
                    </div>
                    
                    <div class="d-flex align-items-center gap-2">
                        @if (task.IsDone)
                        {
                            <span class="badge text-bg-success">Done</span>
                        }
                        else
                        {
                            <span class="badge text-bg-secondary">Open</span>
                        }
                        
                        <div class="btn-group btn-group-sm">
                            @* Details button - loads into modal *@
                            <button type="button" 
                                    class="btn btn-outline-secondary"
                                    hx-get="?handler=Details&id=@task.Id"
                                    hx-target="#task-modal-container"
                                    hx-indicator="#task-loading">
                                Details
                            </button>
                            
                            @* Delete button with confirmation *@
                            <button type="button"
                                    class="btn btn-outline-danger"
                                    hx-post="?handler=Delete"
                                    hx-vals='{"id": @task.Id, "Q": "@(Model.Query ?? "")", "PageNum": @Model.Page, "Size": @Model.PageSize}'
                                    hx-confirm="Delete this task? This cannot be undone."
                                    hx-target="#task-list"
                                    hx-swap="outerHTML"
                                    hx-indicator="#task-loading">
                                Delete
                            </button>
                        </div>
                    </div>
                </li>
            }
        </ul>
        
        @* Pagination Controls *@
        @if (Model.TotalPages > 1)
        {
            <div class="card-footer d-flex justify-content-between align-items-center bg-transparent border-top-0 pt-4">
                <div class="small text-muted">
                    Showing <strong>@((Model.Page - 1) * Model.PageSize + 1)</strong> to 
                    <strong>@(Math.Min(Model.Page * Model.PageSize, Model.Total))</strong> of 
                    <strong>@Model.Total</strong> tasks
                </div>
                
                <nav aria-label="Task list pagination">
                    <ul class="pagination pagination-sm mb-0">
                        @* Previous Page *@
                        <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                            <a hx-get="?Q=@(Model.Query ?? "")&PageNum=@(Model.Page - 1)&Size=@Model.PageSize"
                               hx-target="#task-list"
                               hx-swap="outerHTML"
                               hx-push-url="true"
                               class="page-link" 
                               style="cursor: pointer;"
                               aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>

                        @* Page Numbers *@
                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.Page ? "active" : "")" @(i == Model.Page ? "aria-current='page'" : "")>
                                <a class="page-link"
                                   style="cursor: pointer;"
                                   hx-get="?Q=@(Model.Query ?? "")&PageNum=@i&Size=@Model.PageSize"
                                   hx-target="#task-list"
                                   hx-swap="outerHTML"
                                   hx-push-url="true">
                                    @i
                                </a>
                            </li>
                        }

                        @* Next Page *@
                        <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                            <a class="page-link"
                               style="cursor: pointer;"
                               hx-get="?Q=@(Model.Query ?? "")&PageNum=@(Model.Page + 1)&Size=@Model.PageSize"
                               hx-target="#task-list"
                               hx-swap="outerHTML"
                               hx-push-url="true"
                               aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    }
</div>
